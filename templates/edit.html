<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Edit Data</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script>
      function onActionChange() {
        var action = document.querySelector('select[name="action"]').value;
        // Hide all optional fields first
        document.querySelectorAll('.optfield').forEach(e => e.style.display='none');
        if(action === 'fill_value') {
          document.getElementById('valuefield').style.display='inline-block';
        } else if(action === 'replace') {
          document.getElementById('oldfield').style.display='inline-block';
          document.getElementById('newfield').style.display='inline-block';
        } else if(action === 'drop_duplicates') {
          document.getElementById('dupfield').style.display='inline-block';
        } else if(action === 'astype') {
          document.getElementById('astypefield').style.display='inline-block';
        } else if(action === 'add_column') {
          document.getElementById('valuefield').style.display='inline-block';
        } else if(action === 'calc_column') {
          document.getElementById('calcfield').style.display='inline-block';
          document.getElementById('newfield').style.display='inline-block';
        }
      }
      window.onload = onActionChange;
    </script>
  </head>
  <body>
    <div class="container">
      <img src="https://cdn-icons-png.flaticon.com/512/2991/2991108.png" class="logo" alt="logo">
      <h1>Editing Dataset</h1>
      <div class="info">
        <p><b>Rows:</b> {{ info.rows }} | <b>Columns:</b> {{ info.cols }} | <b>Duplicates:</b> {{ info.duplicates }}</p>
      </div>
      <div class="actions">
        <form method="post" action="/apply/{{ uid }}">
          <label>Kolom:</label>
          <select name="column">
            <option value="">-- Semua kolom --</option>
            {% for c in columns %}
            <option value="{{ c }}">{{ c }}</option>
            {% endfor %}
          </select>
          <label>Aksi:</label>
          <select name="action" onchange="onActionChange()">
            <option value="dropna">Hapus baris kosong</option>
            <option value="fill_value">Isi dengan nilai</option>
            <option value="ffill">Forward fill</option>
            <option value="bfill">Backward fill</option>
            <option value="median">Isi dengan median</option>
            <option value="mode">Isi dengan modus</option>
            <option value="mean">Isi dengan rata-rata</option>
            <option value="drop_duplicates">Hapus duplikat</option>
            <option value="drop_column">Drop kolom</option>
            <option value="add_column">Tambah kolom baru</option>
            <option value="calc_column">Perhitungan kolom baru</option>
            <option value="replace">Ganti nilai</option>
            <option value="normalize_lower">Lowercase</option>
            <option value="normalize_strip">Strip whitespace</option>
            <option value="normalize_clean">Hapus karakter non-alfabet</option>
            <option value="astype">Ubah tipe data</option>
            <option value="outlier_iqr">Hapus outlier IQR</option>
          </select>
          <input type="text" class="optfield" id="valuefield" name="value" placeholder="nilai untuk fill, nama kolom baru" style="display:none;">
          <span class="optfield" id="calcfield" style="display:none;">
            <label style="margin-left:8px;">Operasi:</label>
            <select name="calc_op">
              <option value="add">Penjumlahan (+)</option>
              <option value="sub">Pengurangan (-)</option>
              <option value="mul">Perkalian (*)</option>
              <option value="div">Pembagian (/)</option>
              <option value="single">Operasi single kolom</option>
            </select>
            <label>Kolom 1:</label>
            <select name="calc_col1">
              {% for c in columns %}
              <option value="{{ c }}">{{ c }}</option>
              {% endfor %}
            </select>
            <label id="calc_col2_label">Kolom 2:</label>
            <select name="calc_col2">
              <option value="">--</option>
              {% for c in columns %}
              <option value="{{ c }}">{{ c }}</option>
              {% endfor %}
            </select>
            <input type="text" name="calc_single_exp" placeholder="exp: x*0.1 (untuk single kolom)" style="width:120px;">
          </span>
          <input type="text" class="optfield" id="oldfield" name="old" placeholder="old value (replace)" style="display:none;">
          <input type="text" class="optfield" id="newfield" name="new" placeholder="new value (replace/kolom baru)" style="display:none;">
          <input type="text" class="optfield" id="dupfield" name="dup_subset" placeholder="kolom duplikat (misal: col1,col2)" style="display:none;">
          <select class="optfield" id="astypefield" name="to_type" style="display:none;">
            <option value="str">String</option>
            <option value="int">Integer</option>
            <option value="float">Float</option>
            <option value="datetime">Datetime</option>
          </select>
          <button type="submit">Apply</button>
        </form>
        <a class="download" href="/download/{{ uid }}?fmt=csv">Download CSV</a>
      </div>
      <div class="preview">
        {{ head_html | safe }}
      </div>
    </div>
    <script>
      // Hide/show Kolom 2 dan ekspresi single kolom sesuai operasi
      document.querySelector('select[name="calc_op"]').onchange = function() {
        var op = this.value;
        document.querySelector('select[name="calc_col2"]').style.display = (op==='single') ? 'none' : 'inline-block';
        document.getElementById('calc_col2_label').style.display = (op==='single') ? 'none' : 'inline-block';
        document.querySelector('input[name="calc_single_exp"]').style.display = (op==='single') ? 'inline-block' : 'none';
      };
    </script>
  </body>
</html>
